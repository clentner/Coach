version: 3

targets:
  - id: patellar_hsr_squat_sets
    window_days: 7
    type: sets
    goal: 4

  - id: patellar_hsr_sl_press_sets
    window_days: 7
    type: sets
    goal: 4

  - id: patellar_stairmaster_minutes
    window_days: 7
    type: minutes
    goal: 20

  - id: hip_abductor_sets
    window_days: 7
    type: sets
    goal: 8

  - id: hip_flexor_sets
    window_days: 7
    type: sets
    goal: 6

  - id: mobility_minutes
    window_days: 5
    type: minutes
    goal: 45

  - id: fcu_rehab_sets
    window_days: 7
    type: sets
    goal: 18

  - id: zone2_minutes
    window_days: 7
    type: minutes
    goal: 90

  - id: zone4_minutes
    window_days: 7
    type: minutes
    goal: 20

  - id: full_body_strength_sets
    window_days: 7
    type: sets
    goal: 18

fatigue_constraints:
  knee:
    - kind: prior_load_lt
      window_hours: 36
      threshold: 0.75
      applies_to_blocks_with_tag: [knee_heavy]
      reason: "Squats/leg press only if knee load (36h) < 0.75"

    - kind: prior_load_lt
      window_hours: 24
      threshold: 1.0
      applies_to_blocks_with_tag: [knee_light]
      reason: "Cardio / light knee work only if knee load (24h) < 1.0"

  cns:
    - kind: prior_load_lt
      window_hours: 72
      threshold: 2.0
      # Now specifically restricts heavy compounds when systemically fatigued
      applies_to_blocks_with_tag: [compound_heavy]
      reason: "Heavy compounds only if CNS load (72h) < 2.0"

priority_order:
  - patellar_tendon
  - hip_abductors
  - mobility
  - fcu_rehab
  - hip_flexors
  - cardio
  - strength_full_body

priorities:
  patellar_tendon:
    blocks:
      - block_name: hsr_squat
        size_minutes: 30
        location: gym
        tags: [rehab, strength, patellar_tendon, knee_heavy, compound_heavy]
        fatigue_loads:
          knee: 1.0
          cns: 1.0
        contributes_to:
          - { target: patellar_hsr_squat_sets }
        prescription:
          - exercise: squat
            sets: 4
            reps: 8
            tempo: "3030"
        progression:
          type: linear_load
          every_n_sessions: 2
          parameters:
            start_load_lbs: 85
            increment_load_lbs: 5

      - block_name: hsr_single_leg_press
        size_minutes: 30
        location: gym
        tags: [rehab, strength, patellar_tendon, knee_heavy]
        fatigue_loads:
          knee: 1.0
          cns: 0.5
        contributes_to:
          - { target: patellar_hsr_sl_press_sets }
        prescription:
          - exercise: single_leg_press
            sets: 4
            reps: 9
            tempo: "3030"
        progression:
          type: linear_load
          every_n_sessions: 2
          parameters:
            start_load_lbs: 140
            increment_load_lbs: 10

      - block_name: stairmaster_rehab
        size_minutes: 20
        location: gym
        tags: [rehab, cardio, patellar_tendon, zone2, knee_light]
        fatigue_loads:
          knee: "$performed_minutes * 0.5 / 20"
          cns: "$performed_minutes * 0.25 / 30"
        contributes_to:
          - { target: patellar_stairmaster_minutes }
          - { target: zone2_minutes }
        prescription:
          - exercise: stairmaster
            target: Z2
        progression:
          type: per_session_minutes
          parameters:
            start_minutes: 20
            increment_minutes: 2
            max_minutes: 40

  hip_abductors:
    blocks:
      - block_name: banded_x_walks
        size_minutes: 8
        location: anywhere
        tags: [rehab, hip_abductor]
        fatigue_loads: {}
        contributes_to:
          - { target: hip_abductor_sets }
        prescription:
          - exercise: banded_x_walks
            sets: 2

      - block_name: banded_clamshells
        size_minutes: 8
        location: anywhere
        tags: [rehab, hip_abductor]
        fatigue_loads: {}
        contributes_to:
          - { target: hip_abductor_sets }
        prescription:
          - exercise: banded_clamshells
            sets: 2
            per_side: true

  mobility:
    blocks:
      - block_name: full_mobility
        size_minutes: 45
        location: anywhere
        tags: [mobility]
        fatigue_loads: {}
        contributes_to:
          - { target: mobility_minutes }
        prescription:
          - exercise: foot_foam_roll
            seconds: 90
            per_side: true
          - exercise: calf_stretch
            sets: 3
            per_side: true
          - exercise: sciatic_floss
            sets: 3
            reps: 8
            tempo: "3030"
            per_side: true
          - exercise: pike_block_crush
            sets: 1
            reps: 3
            seconds_per_rep: 10
          - exercise: pike_lift_cracrk
            sets: 3
            reps: 5
            tempo: "5050"
            per_side: true

  fcu_rehab:
    blocks:
      - block_name: wrist_isometrics
        size_minutes: 10
        location: anywhere
        tags: [rehab, forearm]
        fatigue_loads: {}
        contributes_to:
          - { target: fcu_rehab_sets }
        prescription:
          - exercise: wrist_flexion_iso
            sets: 5
            seconds: 30
          - exercise: wrist_extension_iso
            sets: 5
            seconds: 30

      - block_name: wrist_flexion_eccentrics
        size_minutes: 10
        location: anywhere
        tags: [rehab, forearm]
        fatigue_loads: {}
        contributes_to:
          - { target: fcu_rehab_sets }
        prescription:
          - exercise: wrist_flexion_eccentric
            sets: 3
            reps: 15
            tempo: "4010"

  hip_flexors:
    blocks:
      - block_name: deadbugs
        size_minutes: 6
        location: anywhere
        tags: [maintenance, core, hip_flexor]
        fatigue_loads: {}
        contributes_to:
          - { target: hip_flexor_sets }
        prescription:
          - exercise: deadbug
            sets: 3
            reps: 10

      - block_name: straight_leg_raises
        size_minutes: 6
        location: anywhere
        tags: [maintenance, hip_flexor]
        fatigue_loads: {}
        contributes_to:
          - { target: hip_flexor_sets }
        prescription:
          - exercise: straight_leg_raise
            sets: 3
            reps: 10
            per_side: true

  cardio:
    blocks:
      - block_name: zone2_cardio
        # LOGIC:
        # 1. Filter sizes that fit in today_time_available.
        # 2. Of those, filter for 'necessary' sizes:
        #    (size <= target_deficit) OR (size is the smallest available > target_deficit).
        # 3. Choose the largest size remaining.
        size_minutes: [20, 30, 45]
        location: anywhere
        tags: [cardio, zone2, knee_light]
        fatigue_loads:
          knee: "$performed_minutes * 0.3 / 30"
          cns: "$performed_minutes * 0.25 / 30"
        contributes_to:
          - { target: zone2_minutes }
        prescription:
          - exercise: bike_or_row_or_treadmill
            target: Z2

      - block_name: zone4_intervals
        size_minutes: 20
        location: anywhere
        tags: [cardio, zone4, knee_light]
        fatigue_loads:
          knee: "$performed_minutes * 0.4 / 20"
          cns: 1.0
        contributes_to:
          - { target: zone4_minutes }
        prescription:
          - exercise: bike_preferred
            interval_protocol: "4x4"

  strength_full_body:
    blocks:
      - block_name: deadlift
        size_minutes: 20
        location: gym
        tags: [strength, aesthetics, compound_heavy]
        fatigue_loads:
          knee: 0.6
          cns: 1.0
        contributes_to:
          - { target: full_body_strength_sets }
        prescription:
          - exercise: deadlift
            sets: 3
            reps: 5
            rpe: 7

      - block_name: bench_press
        size_minutes: 20
        location: gym
        tags: [strength, aesthetics, upper_body, compound_heavy]
        fatigue_loads:
          knee: 0.0
          cns: 0.5
        contributes_to:
          - { target: full_body_strength_sets }
        prescription:
          - exercise: bench_press
            sets: 3
            reps: 6
            rpe: 7

      - block_name: overhead_press
        size_minutes: 20
        location: gym
        tags: [strength, aesthetics, upper_body, compound_heavy]
        fatigue_loads:
          knee: 0.0
          cns: 0.5
        contributes_to:
          - { target: full_body_strength_sets }
        prescription:
          - exercise: overhead_press
            sets: 3
            reps: 6
            rpe: 7

selection:
  strategy: greedy_strict
  
